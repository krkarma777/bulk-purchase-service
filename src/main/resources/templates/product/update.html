<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Edit Product</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/common.css">
    <style>
        .container {
            max-width: 560px;
        }

        .field-error {
            border-color: #dc3545;
            color: #dc3545;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script th:inline="javascript">
        $(document).ready(function () {
            var uploadedImages = /*[[${product.imageUrls}]]*/ []; // Thymeleaf로부터 이미지 URL 리스트 초기화


            // 초기 이미지 리스트 로드
            function loadInitialImageList() {
                // 서버에서 가져온 이미지 URL 리스트를 사용하여 초기화
                // 예: uploadedImages = ['image1.jpg', 'image2.jpg', ...];
                uploadedImages.forEach(function(imageUrl) {
                    addHiddenInput(imageUrl);
                });
                updateImageList();
            }
            $("#image").change(function () {
                var files = $('#image')[0].files;
                for (var i = 0; i < files.length; i++) {
                    var formData = new FormData();
                    formData.append('image', files[i]);

                    $.ajax({
                        url: '/upload-image',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (data) {
                            var imageUrl = data.imageUrl;

                            // 중복된 이미지가 없다면 배열에 추가
                            if (imageUrl != null && !uploadedImages.includes(imageUrl)) {
                                uploadedImages.push(imageUrl);
                                addHiddenInput(imageUrl);
                            }
                            updateImageList();
                        },
                        error: function (xhr, status, error) {
                            alert("이미지 업로드 실패: " + error);
                        }
                    });
                }
            });
            // 업로드한 이미지 리스트를 업데이트하는 함수

            function updateImageList() {
                // 기존에 표시된 이미지 리스트 업데이트
                $('#image-list').empty();
                uploadedImages.forEach(function(imageUrl, index) {
                    $('#image-list').append(
                        '<div><img src="/images/' + imageUrl + '" style="width: 100px; height: auto;">' +
                        '<button type="button" onclick="removeImage(\'' + imageUrl + '\')">Remove</button></div>'
                    );
                });
            }
            function addHiddenInput(imageUrl) {
                var input = $('<input>').attr({
                    type: 'hidden',
                    name: 'imageUrls',
                    value: imageUrl
                });
                $('form').append(input);
            }

            window.removeImage = function(imageUrl) {
                uploadedImages = uploadedImages.filter(function(url) {
                    return url !== imageUrl;
                });
                updateImageList();
            };

            loadInitialImageList();

            // 폼 제출 이벤트 핸들러
            $('form').on('submit', function() {
                $('input[name="imageUrls"]').each(function() {
                    if (!this.value || this.value.trim() === '') {
                        $(this).remove(); // 무효한 필드 제거
                    }
                });
            });
        });
    </script>
</head>
<body>
<div th:replace="~{common/navBar :: content}"></div>

<div class="container mt-5">
    <h2>Edit Product</h2>
    <form th:action="@{/product/update/{productId}(productId=${product.productID})}" th:object="${product}" method="post" enctype="multipart/form-data">
        <input type="hidden" name="productID" th:field="*{productID}" th:value="*{productID}">
        <input type="hidden" name="user" th:field="*{user}" th:value="*{user}">
        <input type="hidden" name="salesRegions" th:field="*{salesRegions}" th:value="*{salesRegions}">

        <div class="form-group">
            <label for="productName" th:text="#{label.product.name}">Product Name</label>
            <input type="text" th:field="*{productName}" th:errorclass="field-error" class="form-control" id="productName" placeholder="Enter product name">
        </div>
        <div class="field-error" th:errors="*{productName}">
            상품명 오류
        </div>
        <div class="form-group">
            <label for="description" th:text="#{label.product.description}">Description</label>
            <textarea th:field="*{description}" th:errorclass="field-error" class="form-control" id="description" rows="3" placeholder="Enter description"></textarea>
        </div>
        <div class="field-error" th:errors="*{description}">
            description 오류
        </div>
        <div class="form-group">
            <label for="price" th:text="#{label.product.price}">Price</label>
            <input type="number" th:field="*{price}" th:errorclass="field-error" class="form-control" id="price" placeholder="Enter price">
        </div>
        <div class="field-error" th:errors="*{price}">
            price 오류
        </div>
        <div class="form-group">
            <label for="stock" th:text="#{label.product.stock}">Stock</label>
            <input type="number" th:field="*{stock}" th:errorclass="field-error" class="form-control" id="stock" placeholder="Enter stock">
        </div>
        <div class="field-error" th:errors="*{stock}">
            stock 오류
        </div>
        <div class="form-group">
            <label for="image">Images</label>
            <div id="image-list">
                <!-- 기존 이미지 목록을 표시하고, 각 이미지에 삭제 버튼을 제공 -->
                <div th:each="imageUrl : ${product.imageUrls}">
                    <img th:src="@{'/images/' + ${imageUrl}}" style="width: 100px; height: auto;"/>
                    <button type="button" onclick="removeImage('${imageUrl}')">Remove</button>
                </div>
            </div>

        </div>

        <!-- 다른 필드들 추가 -->
        <button type="submit" class="btn btn-primary">Update Product</button>

        <!-- 이미지 업로드 부분 -->
        <div class="form-group">
            <label for="image">이미지 업로드</label>
            <input type="file" class="form-control" id="image" name="image" multiple> <!-- multiple 속성 추가 -->
        </div>

    </form>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
