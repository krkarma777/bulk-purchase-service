<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>장바구니</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script
            src="https://code.jquery.com/jquery-3.7.1.js"
            integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
            crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="/css/common.css">
</head>
<body>
<div th:replace="~{common/navBar :: content}"></div>
<div class="container mt-5">
    <h2>장바구니</h2>
    <form th:action="@{/cart/update}" method="post">
        <table class="table">
            <thead>
            <tr>
                <th><input type="checkbox" id="checkAll"/></th>
                <th>상품명</th>
                <th>가격</th>
                <th>수량</th>
                <th>합계</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item : ${cart.items}" th:id="'item-' + ${item.cartItemID}">
                <td><input type="checkbox" th:name="itemId" th:value="${item.cartItemID}"/></td>
                <td th:text="${item.product.productName}">상품명</td>
                <td th:data-price="${item.product.price}" th:text="${#numbers.formatDecimal(item.product.price, 0, 'COMMA', 0, 'POINT')} + '원'">가격</td>
                <td>
                    <button type="button" class="quantity-change" th:data-itemid="${item.cartItemID}"
                            data-operation="decrease">-
                    </button>
                    <input type="number" th:attr="name='quantity-' + ${item.cartItemID}, data-itemid=${item.cartItemID}"
                           th:value="${item.quantity}" min="1" class="quantity-input" pattern="\d*"/>
                    <button type="button" class="quantity-change" th:data-itemid="${item.cartItemID}"
                            data-operation="increase">+
                    </button>
                </td>
                <td class="item-total" th:text="${item.quantity * item.product.price}">합계</td>
                <td>
                    <button type="button" class="delete-btn" th:attr="data-itemid=${item.cartItemID}">삭제</button>
                </td>
            </tr>
            </tbody>
        </table>
        <input type="hidden" id="cartId" name="cartId" th:value="${cart.cartID}"/>
        <button type="button" class="btn btn-danger" onclick="deleteSelectedItems()">선택 삭제</button>
    </form>

    <button type="button" onclick="submitFormWithCartId()" class="btn btn-success">결제하기</button>
    <div class="cart-summary">
        <div class="subtotal">상품가격: <span id="subtotal">0</span>원</div>
        <div class="discount">할인금액: <span id="discount">0</span>원</div>
        <div class="shipping">배송비: <span id="shipping">0</span>원</div>
        <div class="total">총합계: <span id="total">0</span>원</div>
        <button id="checkoutButton" class="btn btn-primary">구매하기 (3)</button>
    </div>

</div>

<script>

    function submitFormWithCartId() {

        var cartId = document.getElementById('cartId').value;
        var form = document.querySelector('form'); // form을 정확히 선택하도록 셀렉터를 조정하세요.
        form.action = '/order/' + cartId;
        form.submit();
    }
    // 아이템의 가격, 할인, 배송비를 업데이트하는 함수
    function updateCartSummary() {
        var subtotal = 0;
        var discount = 0;
        var shipping = 0;

        // 아이템들의 가격을 합산합니다.
        $(".item-total").each(function () {
            subtotal += parseFloat($(this).text());
        });

        // 할인금액과 배송비를 설정합니다. (이 부분은 사이트의 로직에 따라 다를 수 있습니다)
        // 예시로, 150,000원 이상 구매시 5,990원 할인을 적용하는 경우
        if (subtotal >= 150000) {
            discount = 5990;
        }

        // 배송비 계산 로직 (여기서는 무료 배송을 가정합니다)
        shipping = 0; // 배송비 로직에 따라 값을 변경하세요.

        // 최종 합계를 계산합니다.
        var total = subtotal - discount + shipping;

        // HTML 엘리먼트에 값을 설정합니다.
        $("#subtotal").text(subtotal);
        $("#discount").text(discount);
        $("#shipping").text(shipping);
        $("#total").text(total);
    }

    $(document).ready(function () {
        $("#checkAll").click(function () {
            $("input[type='checkbox']").prop('checked', $(this).prop('checked'));
        });

        $('.delete-btn').on('click', function () {
            var itemId = $(this).data('itemid'); // 'data-itemid' 속성에서 itemId를 가져옵니다.
            deleteCartItem(itemId);
        });
    });


    function deleteCartItem(itemId) {
        $.ajax({
            url: '/cart/delete',
            type: 'POST',
            data: {itemId: itemId},
            success: function (response) {
                // 삭제 성공 시 페이지에서 해당 항목 제거
                // 예: $('#item-' + itemId).remove();
                alert('상품이 삭제되었습니다.');
                $('#item-' + itemId).remove();
                updateCartSummary();
            },
            error: function (xhr, status, error) {
                // 에러 처리, 서버로부터의 응답을 바탕으로 메시지를 표시
                var errorMessage = xhr.responseJSON ? xhr.responseJSON.message : '삭제 중 오류가 발생했습니다.';
                alert('삭제 중 오류가 발생했습니다.');
            }
        });
    }

    function deleteSelectedItems() {
        var selectedItems = [];
        $("input[name='itemId']:checked").each(function () {
            selectedItems.push($(this).val());
        });

        $.ajax({
            url: '/cart/deleteSelected',
            type: 'POST',
            traditional: true,
            data: {itemIds: selectedItems},
            success: function (response) {
                // 성공 처리
                alert('선택된 상품이 삭제되었습니다.');
                location.reload(); // 페이지 새로고침
                updateCartSummary();
            },
            error: function (error) {
                // 실패 처리
                alert('삭제 중 오류가 발생했습니다.');
            }
        });
    }

    $(document).ready(function () {
        // 수량 조정 버튼 클릭 이벤트
        $('.quantity-change').click(function () {
            var itemId = $(this).data('itemid');
            var operation = $(this).data('operation');
            var input = $("input[name='quantity-" + itemId + "']");
            var currentQuantity = parseInt(input.val());

            if (operation === "increase") {
                currentQuantity += 1;
            } else if (operation === "decrease" && currentQuantity > 1) {
                currentQuantity -= 1;
            }

            input.val(currentQuantity);
            updateCartItemQuantity(itemId, currentQuantity);
            updateCartSummary();
        });

        // 수량 입력 변경 이벤트
        $(document).on('change', '.quantity-input', function () {
            var itemId = $(this).data('itemid');
            var quantity = $(this).val();
            // If the field is empty, set the quantity to 1
            if (quantity === '') {
                quantity = '1';
                $(this).val(quantity);
            }
            updateCartItemQuantity(itemId, quantity);
        });
        updateCartSummary();
    });

    function updateCartItemQuantity(itemId, quantity) {
        $.ajax({
            url: '/cart/update',
            type: 'POST',
            data: {
                itemId: itemId,
                quantity: quantity
            },
            success: function (response) {
                var price = $("tr[id='item-" + itemId + "']").find("td[data-price]").data('price');
                var newTotal = price * quantity;
                $("tr[id='item-" + itemId + "']").find(".item-total").text(newTotal);
                updateCartSummary();
            },
            error: function (error) {
                alert('수량 업데이트 중 오류가 발생했습니다.');
            }
        });

// 페이지가 준비된 후 초기 한 번만 장바구니 요약을 업데이트합니다.
        $(document).ready(function () {
            updateCartSummary();
        });

        $(document).on('input', '.quantity-input', function() {
            this.value = this.value.replace(/\D/g, '');
        });
        $('.quantity-input').on('change', function() {
            updateCartItemQuantity($(this).data('itemid'), $(this).val());
        });
        updateCartSummary();
    }


</script>
<script
        src="https://code.jquery.com/jquery-3.7.1.js"
        integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</body>
</html>
